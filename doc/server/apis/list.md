# /list API仕様

`/list.php` は、JSONドキュメントを検索・取得するためのAPIです。
ページネーション機能を備え、指定した範囲のドキュメント情報をリスト形式で返します。

## リクエストパラメータ

| パラメータ名 | 説明 |
|---|---|
| **offset** または **uuid** | リストの先頭位置を指定します。<br>indexの場合は、先頭からの通し番号を指定します。<br>uuidの場合は、指定したUUIDのドキュメントを基準とし、その中で最も古いものを先頭にします。<br>省略時は`offset=0`です。 |
| **page** | offsetの代替指定方法です。<br>`limit`と組み合わせることで、`limit * page` を先頭位置として計算します。<br>省略時は`page=0`です。 |
| **limit** | 返却する項目数の上限を指定します。<br>省略時は`limit=100`です。 |
| **path** | JSONデータ内の指定したパスが存在するドキュメントのみを返却します。<br>省略時は無視します。 |
| **value** | `path`で指定した要素の値が一致するドキュメントのみを返却します。<br>省略時は無視します。 |

---

### 抽出条件の動作

`limit` で指定した最大件数分のデータを取得した後、その範囲内で`path`および`value`による条件抽出を行います。  
例えば、対象データが1000件存在し、`offset=100`、`limit=100`を指定した場合、記録順に昇順に並べた後に、100件目から100件取得し、その中から`path`と`value`に一致するデータを抽出します。  
条件に一致するデータがない場合、返却件数は0件となります。

### パス指定の注意事項

- SQLiteの[JSON1拡張](https://www.sqlite.org/json1.html#jexb)の`json_extract`関数が使用されます。
- 条件式や演算式は指定できません。
- `value`は、指定したパスのノードの文字列表現と完全一致する必要があります。

---

## リクエスト形式

```http
GET /api/list.php?offset=3&limit=9&path=$.key2&path=$.aaaa
```

---

## レスポンス仕様

### 成功時

```json
{
  "success": true,
  "result": {
    "total": 7,
    "range": {
      "offset": 3,
      "limit": 3
    },
    "table": {
      "head": [
        "timestamp",
        "uuid_storage",
        "uuid_account",
        "size",
        "hash"
      ],
      "rows": [
        [1741094839673, "01956156-e65f-73f6-bdb7-a22f4d97325c",
          "01956156-0db1-73ce-83a4-2f2b223848aa",
          15, "7c5fcd3d422d279f9b4495207ece7d58fe9f934343803a304fec4b1216c51dc4"
        ],
        [1741094844322, "01956156-f881-705b-b79e-908615d91fcc",
          "01956156-0db1-73ce-83a4-2f2b223848aa",
          15, "853faebd99b50e6067045774158d5321e3e1f241a72281305048b53fe85fd9fc"
        ],
        [1741094912255, "01956158-02bb-735e-8a02-4aceb89e4399",
          "01956156-0db1-73ce-83a4-2f2b223848aa",
          15, "b679c932bc00e7e56f0bb5ebc1dceb5089016f6cefe6d5117baa82ae045feb99"
        ],
      ]
    }
  }
}
```

### フィールド説明

- **success**  
    処理結果。`true`の場合は成功、`false`の場合は失敗です。

- **result**  
    結果を格納します。
    - **total**  
        レコードの総数です。
    - **range**
        探索範囲を示します。
    - **table**  
        - **head**
            列名の配列です。
        - **rows**  
            条件に一致したレコードです。
---

tableのheadはrowsの列の順位に対応します。timestampはms単位のunixtimeです。

sizeは格納されているjsonをシステムがレンダリングしたときのバイト単位の値です。この値は記録時に送信したJSONのサイズとは異なります。確定値として使用しないでください。

### 失敗時

エラーが発生した場合は、[`エラーコード`](./errorcodes.md)を参照してください。

