# JsonPost実装についての各種考察


JsonPostではPowStampの機能を使って通信とアクセス制御を実装します。

PowStampの各種フィールド値や通信を、どのように運用するかの方針を考察します。



## PowStampの利用シーンの考察

PowStampは、クライアントからサーバへの処理要求に付帯します。
アクセス条件はクライアントでPowStampを計算するためのパラメータです。


利用シーンは3通りを想定しています。


### 同期システム(双方向)

クライアントは任意のタイミングでサーバーがクライアントに要求するアクセス条件を確認することができます。  
PowStampは常にサーバの提示するアクセス条件に一致させなければなりません。  
リクエストの結果は即座に取得可能ですが、通信に失敗した場合は結果不明の場合もあります。

クライアントはリクエストの送信前にアクセス条件を確認するべきであり、リクエストの送信後にアクセス条件を更新するべきです。
サーバは、クライアントのアクセス条件を予測不能な形で更新することができます。


### 非同期システム(片方向)

サーバの認証状況を確認できない片方向システムの場合、クライアントが既知なのは、事前にプリセットしたアクセス条件だけです。  
初回を除き、アクセス条件はクライアント単独で予測可能でなければなりません。

リクエストの結果は常に不明です。サーバのアクセス条件の更新は、クライアントの状態に依存します。


### 混合システム

基本的には片方向システムですが、完結で双方向システムとして同期を取るシステムです。

クライアントは同期のタイミングでアクセス条件をサーバの状態にロールバックします。



## リプレイの考察


PowStampは使い捨ての認証キーとして設計されていますが、再利用された場合に、システムがどのように振舞うべきかを考察します。

### 同一サーバ内でのリプレイプロテクション

PowStampはサーバに受理された時点で、そのサーバ内では無効化されるべきです。
これにはクライアントによる加算Nonceが有効です。


同期システムの場合、結果不明で使用したNonce値を後続のNonceが超えない、リクエストは必ず１度だけ成功する仕様となります。
ただし、結果不明の場合には次回のリプレイ成功まで結果が不明である点に留意が必要です。結果不明のままクライアントが加算Nonceを変更すると、結果不明のリクエストが失敗していた場合に、そのPowStampが使用不能になります。


非同期システムの場合、リクエストは失われる可能性があります。
Nonceが範囲を持つ(評価式がN < NONCE)場合、途中で失敗したいリクエストは消失します。また、Nonceが一致(評価式がN == NONCE)の場合、一度リクエストが失敗すると以降のリクエストはすべて失敗します。


### 別ドメインサーバー間

同一パラメータで生成された別ドメインのサーバ間でPowStampの再利用を可能にするかは、製品の目的によりますが、コントロールされるべきです。

再利用を可能にする場合は、同一な仕様で入力されたトランザクションは、同一結果を構成するべきです。再利用を不能にする場合は、同一な仕様で入力されたトランザクションであっても、異なる結果構成するべきです。

JsonPostで使用するPowStampのスコア構成要件では、時間要素があり、同一仕様のトランザクションの生成は困難であることから、再利用が不可能であるシステムとして構築するべきです。

再利用不能なPowStampを構成するには、サーバ毎に異なるSeed値を持たなければならず、クライアントはこのSeed値を使ってPowStampを構成するべきです。
Seed値が同一なサーバに対してのリプレイプロテクションは機能しません。


## データ構造についての考察

JsonPostのデータ構造について考察します。


### データの種類

JsonPostはJsonを格納するストレージとしての機能を主として、利用を適正化するための情報も保持します。
このために、アカウントの管理、システムパラメータ、データ、操作履歴のテーブルを基礎として構築します。


- システムパラメータ  
  永続的な固定パラメータと、他のテーブルから復帰可能なキャッシュデータを保持します。
- アカウント管理  
  アカウントはECDSAのPubKeyに内部的な可読識別子をセットにして表現します。
- データ  
  ファイルアップロードによるデータなどを、重複なく効率的に格納します。
- 操作履歴  
  操作履歴を格納します。このテーブルにはハッシュチェーンを用います。


### ハッシュチェーン

ハッシュチェーンは、ブロックチェーン技術の一種です。
JsonPostでは、サーバーが提示するServerHashChainに指定する識別子（ハッシュ）を生成する目的で使用します。

ハッシュチェーンの始祖は、SeedHashを用いたsha256(PowStamp[SeedHash])です。以降のPowStampは、sha256(PowStamp[-1])で
生成され、ハッシュのチェーンを形成します。

この値は、SeedHashが異なる限り、同一サーバ、サーバ間でも一意な値であることを前提にします。


JsonPostはハッシュチェーンを操作履歴のインデクスとして利用します。

### ハッシュチェーンの種類

ハッシュチェーンはシステムが内部的に使用するMainと、アカウントごとに独立して使用するBranchの２種類があります。


Mainチェーンはアカウントの生成を記録するチェーンです。このチェーンはBranchの起点の履歴となります。

Branchはアカウントの操作履歴を記録するチェーンです。アカウント生成される度にMainのチェーンを引き継いで生成され、
ここに既知となったアカウントの操作履歴が追記されていきます。


MainチェーンはBranch生成毎に自動的に伸長してしまうチェーンであり、無限に伸長します

BranchはPowStamp生成時に加算Nonceを消費するため、寿命があります。
ただし、Godアカウントによる属性操作についてはNonceを消費しません。
これはイレギュラーであり、今後のシステムでは是正されるべきでしょう。




<!-- ------------
ここまでかきなおした
------------



既知のアカウントは主チェーンを操作することはできません。


伸長時にデータを登録することで、ストレージとして機能します。


PowStampのServerChainHashに指定するハッシュ値は、チェーンを識別する符号としても利用します。
この符号はチェーンが進むたびに更新する場合と、チェーンが発生したときの値に固定される２つの場合があります。

更新タイプは双方向システムで使用します。この場合、ハッシュ値はそのチェーン上の位置を示します。
固定タイプは型方向システムで使用します。この場合、ハッシュ値はそのチェーンを示します。




## データ


# 手順

## 主チェーンの初期化

未初期化のサーバに対して、クライアントから初期化を実行する手順です。

[C] 主hashのGenesisを生成
[C] 主hashのGenesisにPowStamp(Nonce=0)を作成して送信。
[S] →受信した主hashをGenesisとして登録。PowStampの署名アカウントをID0のブランチを作成






## 手順
未初期化のサーバに対して、

初期化済みサーバーに対して、クライアントが未知のアカウントで初回アクセスする場合のフローは以下の通りです。
サーバ/クライアント

[S]主Hash提示→
[C]鍵生成
[C]PoｗStamp生成
[C]←ブランチ生成
[S]検証、ブランチ生成、主チェーン伸長
[S]Hash更新
[S]主Hash提示(ブランチHashと同じ)→










## PowStampの構成


## 送信と再送信

## 現在の状態を記録

PowStampを用いたサーバとクライアントの認証手順について説明します。


1. サーバーパラメータの取得  
   サーバからServerDomainHashを構成するパラメータとクライアント毎に定められたNonce、現在の目標値に合わせた難易度、まは閾値を取得します。取得できない場合は適当な目標値を定めます。
2. PowStampMessageの構成  
   サーバから得られたNonce以上の値を設定し、PowStampMessageを構成します。
3. PowStampSignatureの構成
   PowStampMessageからPowStampSignatureを構成します。
4. PowStampの構成
   PowNonceの値を変更しながらハッシングを行い、閾値を下回るスコアを目指します。

作成したPowStampと、必要ならペイロードをサーバーに送ります。
サーバがメッセージの受け入れが成功すると、サーバ側は新しいNonceを計算してクライアントに通知します。失敗した場合は1から手順をやり直します。


## アカウントの寿命


サーバはリクエストを受理するごとにNonce値を加算します。Nonceが最大値（UINT32の場合は0xffffffff）に到達すると、そのアカウントは使用不能になります。


## 難易度

難易度は、サーバーの利用が適正であるほど0に近づかなければなりません。特にクライアントとサーバが双方向通信出ない場合は、適正な利用である限り、サーバは常に一定の難易度でクライアントの要求を受理するべきです。 -->
