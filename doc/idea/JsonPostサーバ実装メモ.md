# 機能

サーバサイドの実装方針についてのメモ書き

## 初期化

初期化コマンドは、主チェーンをGenesisHashを起点に生成し、各種パラメータをデータベースに書き込み、以降の
全てのコマンドに備えてシステムを初期化する。

入力パラメータ

- GenesisHash
- Powアルゴリズム
- 入力フィルタ(JCSフラグ、Jsonスキーマ)
- 許可フラグ(welcome)


主チェーンのGenesisHashはサーバ識別子としても機能するため、一意であることが望ましい。


このPowStampはNonce=0でなければならず、Powは要求するべきではない。


PowStampの署名は成立しなければならない。
PowStampの構成に必要なchain_hashは、入力パラメータから得る。





初期化が成功したサーバは、主チェーンのchainHasがGenesisHashと等しく、Nonceが0のシステムでなければならない。






# 状態の提示

状態提示コマンドは、クライアントがサーバにアクセスするための情報を提示する。

クライアントが既知か未知かで異なる。
既知と未知を判定は、クライアントから送信されてきたPowNonceを検査する。

このPowNonceのNonce=0、Hash=0*32でなければならず、Powは要求するべきではない。


未知アカウント

未知アカウントの場合、アクセスできるのは主チェーンのみである。
主チェーンのnonceは0に固定されているため、主チェーンのハッシュだけ提示できれば良い。


既知アカウント

既知アカウントの場合、アクセスできるのはそのアカウントの枝チェーンのみである。
枝チェーンのnonceとハッシュを提示しなければならない。

また、アカウントの付帯情報を提示することもできる。



既知のアカウントは主チェーンを操作することはできません。


伸長時にデータを登録することで、ストレージとして機能します。


PowStampのServerChainHashに指定するハッシュ値は、チェーンを識別する符号としても利用します。
この符号はチェーンが進むたびに更新する場合と、チェーンが発生したときの値に固定される２つの場合があります。

更新タイプは双方向システムで使用します。この場合、ハッシュ値はそのチェーン上の位置を示します。
固定タイプは型方向システムで使用します。この場合、ハッシュ値はそのチェーンを示します。




# 手順

## 主チェーンの初期化

未初期化のサーバに対して、クライアントから初期化を実行する手順です。

[C] 主hashのGenesisを生成
[C] 主hashのGenesisにPowStamp(Nonce=0)を作成して送信。
[S] →受信した主hashをGenesisとして登録。PowStampの署名アカウントをID0のブランチを作成






## 手順
未初期化のサーバに対して、

初期化済みサーバーに対して、クライアントが未知のアカウントで初回アクセスする場合のフローは以下の通りです。
サーバ/クライアント

[S]主Hash提示→
[C]鍵生成
[C]PoｗStamp生成
[C]←ブランチ生成
[S]検証、ブランチ生成、主チェーン伸長
[S]Hash更新
[S]主Hash提示(ブランチHashと同じ)→










## PowStampの構成


## 送信と再送信

## 現在の状態を記録

PowStampを用いたサーバとクライアントの認証手順について説明します。


1. サーバーパラメータの取得  
   サーバからServerDomainHashを構成するパラメータとクライアント毎に定められたNonce、現在の目標値に合わせた難易度、まは閾値を取得します。取得できない場合は適当な目標値を定めます。
2. PowStampMessageの構成  
   サーバから得られたNonce以上の値を設定し、PowStampMessageを構成します。
3. PowStampSignatureの構成
   PowStampMessageからPowStampSignatureを構成します。
4. PowStampの構成
   PowNonceの値を変更しながらハッシングを行い、閾値を下回るスコアを目指します。

作成したPowStampと、必要ならペイロードをサーバーに送ります。
サーバがメッセージの受け入れが成功すると、サーバ側は新しいNonceを計算してクライアントに通知します。失敗した場合は1から手順をやり直します。


## アカウントの寿命


サーバはリクエストを受理するごとにNonce値を加算します。Nonceが最大値（UINT32の場合は0xffffffff）に到達すると、そのアカウントは使用不能になります。


## 難易度

難易度は、サーバーの利用が適正であるほど0に近づかなければなりません。特にクライアントとサーバが双方向通信出ない場合は、適正な利用である限り、サーバは常に一定の難易度でクライアントの要求を受理するべきです。 -->
