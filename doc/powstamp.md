# POWSTAMP

POWSTAMPは、クライアントがサーバーに送信するバイトストリームです。
このデータはクライアントがサーバーにリクエストの正当性を説明する目的で作成して送信します。
基本的には1回限りの使い捨ての情報です。 APIが受理されるたび作り直す必要があります。




## 構成

POWSTAMPはECDSA署名(EcdsaSignature)、ECDSA署名を検証するためのメッセージ(Message)、PoWハッシングで得るPowNonce値(PowNonce)で構成します。
署名を行うのはクライアントで、初回の通信時に永続的に有効なECDSAのプライベートキーを生成し、これにより署名を行います。


**POWSTAMP**
|フィールド名|サイズ(byte)||
|--|--|--|
|PowStampSignature|64|ECDSA.sign(PowStampMessage)|
|EcdsaPublicKey|33|プレフィクス付キー|
|Nonce|4|メッセージNonce|
|PowNonce|4|ハッシングNonce|
||||
|total|105||








署名を行うメッセージは、サーバー由来とクライアント由来の２つがあり、それらを一定の方式で連結して作成します。

**PowStampMessage**
|フィールド名|サイズ(byte)||
|--|--|--|
|EcdsaPublicKey|33|プレフィクス付キー|
|Nonce|4|メッセージNonce|
|ServerDomainHash(sha256)|32||
|PayloadHash(sha256)|32||
||||
|total|101||


ServerDomainHashは、Publicサーバーの場合は0を指定します。
PayloadHashは、ペイロードを持たない場合は0を指定します。



結合した値を205文字のhex値として送信します。
PowStampSignatureは以下のバイト列のSHA256ハッシュです。


この２つのパラメータは、サーバー側の固有パラメータをリクエストの一部であるため、POW_STAMPには含まれません

### POW_STAMPのスコア
sha256d(POW_STAMP)で得たハッシュ値の先頭から32ビットのbigendian-UINTがスコア値です。
この値はとして使われ、APIの実行時に内部の閾値と比較します。

閾値は機能毎に異なり、APIが要求する閾値は/diff.phpで取得できます。


# POW閾値（難易度）

POW閾値はサーバによって計算されるハッシングの難易度です。サーバはPOW_STAMPのスコア値と比較し、POW_STAMPスコアが閾値を下回るリクエストだけを受理します。


定義済の閾値は以下の通りです。

## TimeLogiticsSizeLogNormal(e,s,s_sigma) 

postペイロードのサイズと、前回のアップロードからの経過時間から計算します。
初回のアップロードは最後の初回登録からの経過時間を代わりに用います。

アップロードのドメインはrootとuserの2つがあり、rootはuserが不明な場合に使います。

計算した値Rは、[0,1]の範囲にある確率値であり、これを以下の式で閾値に変換します。
````
難易度=(32*R)
閾値=2^難易度
````

### 算出アルゴリズム

postペイロードのサイズPAYLOAD_SIZEは、以下の変換式でレートPSに変換します。
PSはピーク値で除算して[0,1]に正規化します。

PS=対数標準偏差(PAYLOAD_SIZE,SIGMA,MU)

パラメータ
- SIGMA 対数標準偏差のσ値。
- MU 収集するファイルサイズ分布の中心

ファイルサイズがMUに近いほどPSの値が1に近づきます。


経過時間ELAPSE_TIMEは以下の変換式でレートTに変換します。

T=ロジスティック関数(ELAPSE_TIME,HALF_T_POINT)

パラメータ
- HALF_T_POINT ロジティクス関数の最大値の0.5倍に到達する経過時間です。目標経過時間の0.5倍を指定します。

経過時間がHALF_T_POINTの2倍を超えると、Tの値は1に収束します。


PSとTの積を計算し、[0,1]の値を得ます。この値は、経過時刻とファイルサイズが目標値に近い確率値になります。


補正アルゴリズム（オプション）

ハッシング性能の高いシステムが接続してきた場合、レートTが正しく機能しない場合があります。
その場合、一時的にHALF_T_POINTをどうにかするひつようがあるからグラフ確認しながらやる。



