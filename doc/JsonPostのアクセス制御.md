# JsonPostのアクセス制御

JsonPostは、クライアントのファイルアップロードに対してPowStampを利用し、リクエストの正当性を検証しつつ、適正な利用を促すための制御を行います。

JsonPostのアクセス制御は、次の2つの評価方式によって実現されます。

- **TimeLogiticsSizeLogNormal関数によるアクセス条件の提示**：アップロードサイズとアクセス間隔を評価し、適正なPowStampスコアの閾値（ハッシングコスト）を提示する方式です。
- **Nonceによる生存期間管理**：各アカウントの`nonce`を利用してアカウントの生存期間を管理し、過剰な利用を抑制する方式です。

## クライアント識別

- JsonPostはクライアントをECDSA署名で識別し、各アカウントは固有の内部パラメータ（`nonce`など）で管理されます。

## アクセス条件の提示

- サーバーはクライアントのアップロードサイズとアクセス間隔を評価し、設定された目標値との乖離に応じて、必要なPowStampスコアの閾値（ハッシングコスト）を算出します。
- クライアントはサーバーから目標値を取得することも、独自に仮定して計算することも可能です。ただし、目標値に近い運用を行えば、PowStampの計算負荷は大幅に軽減されます。
- クライアントは、以下のいずれかの方法でリクエストを受理させる必要があります：
  - Powハッシングによってスコアを満たす
  - アップロードサイズを調整する
  - アクセス可能な時刻まで待機する

## TimeLogiticsSizeLogNormal 方式

この方式は、クライアントのアップロードサイズとアクセス間隔を評価して、PowStampスコアの閾値を算出するものです。

- アップロードサイズを対数正規分布で、アクセス間隔をロジスティック関数で評価し、以下の式で適正度(R)を算出します。

```
R = PSR × ETR
```

- **PSR (Payload Size Rate)**：ファイルサイズを目標サイズに対して対数正規分布で[0,1]に正規化

- **ETR (Elapsed Time Rate)**：アクセス間隔をロジスティック関数で[0,1]に変換

- 最終的な閾値(TH)は、以下の式で算出されます。

```
TH = 2^(R × 32)
```

### パラメータ

- **固定値**

  - ペイロードの適正サイズ（平均値）
  - サイズ分布係数（σ）
  - 適正アップロード間隔

- **変数**

  - 実際のアップロードサイズ
  - 前回のアクセスからの経過時間

### シリアライズ

APIのパラメータ表記は以下の形式です。

```
tlsln(e, s, s_sigma)
```

- **e**：目標アクセス間隔（秒）
- **s**：目標アップロードサイズ（キロバイト）
- **s\_sigma**：アップロードサイズの対数正規分布のσ値

## Nonceによる生存期間管理

この方式は、アカウントの`nonce`値によって生存期間を制御するものです。

- アカウントは`nonce`を保持し、アップロードが成功するたびに`nonce`が加算されます。
- 不適正なリクエストほど`nonce`の加算量が増え、アカウントの寿命が短縮されます。
- `nonce`が最大値（`0xffffffff`）に達すると、アカウントは無効となります。

### ThresholdBaseNonce アルゴリズム

リクエストの閾値（`th`）からコストを算出するアルゴリズムです。

```
cost = 2^(32 - log2(th))
```

- 閾値が低い（難易度が高い）ほど、コストは急激に増加します。

## リクエスト拒否時の通知

- リクエストがPowStampの閾値を満たさない場合、サーバーは以下の情報をクライアントに通知します。
  - **拒否理由**
  - **次回アクセスの推奨条件**（アップロードサイズの調整、次回アクセス可能な時間など）

この仕組みにより、JsonPostは適正な利用を促しつつ、不正なリクエストや過剰な利用を抑制しています。

